{% extends 'base.html' %}
{% load static %}

{% block title %} Todo List {% endblock %}
{% block extra_css %}
<style>    
    a {
        cursor: pointer;
    }
</style>
{% endblock %}

{% block content %}
<div class="modal modal-signin position-static d-block  py-5" tabindex="-1" role="dialog" id="modalSignin">
    <div class="modal-dialog" role="document">
        <div class="modal-content rounded-5 shadow" id="task-container">
            <div class="modal-header p-5 pb-4 border-bottom-0">
                <!-- <h5 class="modal-title">Modal title</h5> -->
                <h2 class="fw-bold mb-0">Todo App</h2>
                <a type="button" class="btn-close" href=""></a>
            </div>

            <div class="modal-body p-5 pt-0" id="form-wrapper">

                <form class="pt-3" id="form">
                    {% csrf_token %}
                    <div class="input-group mb-3">
                        <input type="text" class="form-control rounded-4" name="title" placeholder="Enter task title"
                            aria-label="Recipient's username" aria-describedby="button-addon2" id="title">
                        <button class="btn btn-primary" type="submit" id="submit" >Add</button>
                    </div>



                </form>
                <hr class="my-4">
                <div id="list-wrapper">
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script type="text/javascript">
    /*
    KEY COMPONENTS:
    "activeItem" = null until an edit button is clicked. Will contain object of item we are editing
    "list_snapshot" = Will contain previous state of list. Used for removing extra rows on list update

    PROCESS:
    1 - Fetch Data and build rows "buildList()"
    2 - Create Item on form submit
    3 - Edit Item click - Prefill form and change submit URL
    4 - Delete Item - Send item id to delete URL
    5 - Cross out completed task - Event handle updated item

    NOTES:
    -- Add event handlers to "edit", "delete", "title"
    -- Render with strike through items completed
    -- Remove extra data on re-render
    -- CSRF Token
    */

    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = cookies[i].trim();
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    var csrftoken = getCookie('csrftoken');

    var activeItem = null
    var list_snapshot = []

    buildList()

    function buildList() {
        var wrapper = document.getElementById('list-wrapper')
        var url = 'http://127.0.0.1:8000/todo/api/task-list/'
        fetch(url)
            .then((resp) => resp.json())
            .then(function (data) {
                // console.log('Data:', data)
                var list = data
                for (var i in list) {
                    try {
                        document.getElementById(`data-row-${i}`).remove()
                    } catch (err) {

                    }
                    var title = `<span class="title">${list[i].title}</span>`
                    if (list[i].completed == true) {
                        title = `<strike class="title">${list[i].title}</strike>`
                    }
                    var item = `
                    <div class="input-group py-1" id="data-row-${i}">
                        <span type="text" class="form-control" aria-label="Text input with segmented dropdown button">                        
                        <span>${title}</span>                        
                        </span>
                        <a type="button" class="btn btn-danger delete"><i class="bi bi-trash"></i></a>
                        <button type="button" class="btn btn-primary dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown"
                        aria-expanded="false">
                        <span class="visually-hidden">Toggle Dropdown</span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item done" >Done</a></li>
                        <li><a class="dropdown-item edit">Edit</a></li>
                        </ul>
                    </div>`
                    wrapper.innerHTML += item
                }

                if (list_snapshot.length > list.length) {
                    for (var i = list.length; i < list_snapshot.length; i++) {
                        document.getElementById(`data-row-${i}`).remove()
                    }
                }

                list_snapshot = list


                for (var i in list) {
                    var editBtn = document.getElementsByClassName('edit')[i]
                    var deleteBtn = document.getElementsByClassName('delete')[i]
                    var title = document.getElementsByClassName('title')[i]
                    var done = document.getElementsByClassName('done')[i]


                    editBtn.addEventListener('click', (function (item) {
                        return function () {                            
                            
                            editItem(item)                            
                        }
                    })(list[i]))


                    deleteBtn.addEventListener('click', (function (item) {
                        return function () {
                            deleteItem(item)
                        }
                    })(list[i]))




                    done.addEventListener('click', (function (item) {
                        return function () {                            
                            strikeUnstrike(item)
                        }
                    })(list[i]))


                }


            })
    }


    var form = document.getElementById('form-wrapper')
    form.addEventListener('submit', function (e) {
        e.preventDefault()
        // console.log('Form submitted')
        var url = 'http://127.0.0.1:8000/todo/api/task-create/'
        if (activeItem != null) {
            var url = `http://127.0.0.1:8000/todo/api/task-update/${activeItem.id}/`
            activeItem = null
            document.getElementById('submit').textContent = "Add"  
        }



        var title = document.getElementById('title').value
        fetch(url, {
            method: 'POST',
            headers: {
                'Content-type': 'application/json',
                'X-CSRFToken': csrftoken,
            },
            body: JSON.stringify({ 'title': title })
        }
        ).then(function (response) {
            buildList()
            document.getElementById('form').reset()
        })
    })




    function editItem(item) {
        // console.log('Item clicked:', item);
        document.getElementById('submit').textContent = "change"  
        activeItem = item;              
        document.getElementById('title').value = activeItem.title;
        
    }


    function deleteItem(item) {
        // console.log('Delete clicked')
        fetch(`http://127.0.0.1:8000/todo/api/task-delete/${item.id}/`, {
            method: 'DELETE',
            headers: {
                'Content-type': 'application/json',
                'X-CSRFToken': csrftoken,
            }
        }).then((response) => {
            buildList()
        })
    }

    function strikeUnstrike(item) {
        // console.log('Strike clicked')
        
        item.completed = !item.completed
        fetch(`http://127.0.0.1:8000/todo/api/task-update/${item.id}/`, {
            method: 'POST',
            headers: {
                'Content-type': 'application/json',
                'X-CSRFToken': csrftoken,
            },
            body: JSON.stringify({ 'title': item.title, 'completed': item.completed })
        }).then((response) => {
            buildList()
        })
    }


</script>

{% endblock %}